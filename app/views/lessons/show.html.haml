- content_for :title, "#{@lesson.name} | #{@course.name}"
.container
  .row
    .col-md-12
      %p.breadcrumb.muted
        = link_to "Courses", courses_path
        = " / "
        = link_to @course.name, course_tag_path(@course.tag)
        = " / "
        = link_to @lesson.name, course_tag_lesson_path(@course.tag, @lesson_number), class: "active"
  .row
    .col-md-3
      %h3.table-of-contents-header Table of Contents
      .well-no-padding.course-table-of-contents
        - @course.ordered_units.each do |unit|
          %p.unit-name= unit.name
          %ul
            - unit.ordered_lessons.each do |lesson|
              %a{ href: course_tag_lesson_path(@course_tag, @counter) }
                %li{class: @counter == @lesson_number ? "active" : ""}
                  %p= lesson.name
                  - @counter += 1
      .well.rate{ data: { lesson_id: @lesson.id, liked: @lesson_rating.nil? ? "" : "#{@lesson_rating.like?}"} }
        %h3 Was this lesson helpful?
        .row
          - if current_user
            .col-xs-offset-2.col-xs-4.text-center
              - if @lesson_rating && @lesson_rating.like?
                %span.glyphicon.glyphicon-thumbs-up.rate-button.active
              - else
                %span.glyphicon.glyphicon-thumbs-up.rate-button
            .col-xs-4.text-center
              - if @lesson_rating && !@lesson_rating.like?
                %span.glyphicon.glyphicon-thumbs-down.rate-button.active
              - else
                %span.glyphicon.glyphicon-thumbs-down.rate-button
          - else
            .col-xs-12
              = link_to "Sign in to rate this lesson", lesson_rate_redirect_path
    .col-md-9.lesson
      %h1= @lesson.name
      .lesson-body
        = markdown(@lesson.body)
        %br
        .row
          .col-md-6
            %p
              - if (@lesson_number - 2) >= 0
                = link_to "Previous Lesson: #{@lessons[@lesson_number - 2].name}", course_tag_lesson_path(@course.tag, @lesson_number - 1)
              - else
                = link_to "Back to Course: #{@course.name}", course_tag_path(@course.tag)
          .col-md-6
            %p.text-right
              - if (@lesson_number < @lessons.length)
                = link_to "Next Lesson: #{@lessons[@lesson_number].name}", course_tag_lesson_path(@course.tag, @lesson_number + 1)
              - else
                = link_to "Go to Courses", courses_path

:javascript
  $(function(){

    $(".rate-button").click(function(){
      var ele = $(this),
          container = $(".rate").first(),
          lesson_id = container.data("lesson-id"),
          liked = container.attr("data-liked");

      if(ele.hasClass("glyphicon-thumbs-up")){
        if(liked === true || liked == "true") return;
        liked = true;
      }else{
        if(liked === false || liked == "false") return;
        liked = false;
      }

      $.ajax({
        url : "/lesson/rate",
        type : "POST",
        dataType : "json",
        data : {
          "lesson_id" : lesson_id,
          "liked" : liked
        }
      }).done(function(){
        if(liked){
          $(".glyphicon-thumbs-down").removeClass("active");
          ele.addClass("active");
        }else{
          $(".glyphicon-thumbs-up").removeClass("active");
          ele.addClass("active");
        }
      });
      container.attr("data-liked", liked);

    });
  });
